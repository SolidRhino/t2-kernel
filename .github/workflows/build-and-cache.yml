name: Build and Cache T2 Kernels

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'flake.nix'
      - '.github/workflows/**'
  pull_request:
  schedule:
    # Check for updates daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      force_build:
        description: 'Force build even if no updates'
        required: false
        default: 'false'

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      updated: ${{ steps.check.outputs.updated }}
      should_build: ${{ steps.decide.outputs.should_build }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Install dependencies
        run: |
          nix-env -iA nixpkgs.jq nixpkgs.curl

      - name: Check for kernel updates
        id: check
        run: |
          chmod +x scripts/check-kernel-updates.sh
          ./scripts/check-kernel-updates.sh

      - name: Commit and push updates
        if: steps.check.outputs.updated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add flake.nix
          git commit -m "chore: update kernel versions

          Automated kernel version update by GitHub Actions.

          $(git diff HEAD^ flake.nix | grep -E '^\+.*version = ' || echo 'Updated kernel versions')"
          git push

      - name: Decide if we should build
        id: decide
        run: |
          # Build if:
          # 1. Updates were found
          # 2. Force build is enabled
          # 3. Triggered by push (not schedule)
          if [ "${{ steps.check.outputs.updated }}" == "true" ] || \
             [ "${{ github.event.inputs.force_build }}" == "true" ] || \
             [ "${{ github.event_name }}" == "push" ] || \
             [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-kernels:
    runs-on: ubuntu-latest
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true'
    strategy:
      matrix:
        kernel: [linux-t2-lts, linux-t2-latest]
      fail-fast: false # Continue building other kernels if one fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch latest changes if updates were just pushed
          ref: ${{ github.ref }}

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.ref_name }} || true

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            max-jobs = auto
            cores = 0
            # Enable sandbox for security
            sandbox = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: ${{ secrets.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          # Push all build outputs to cache
          pushFilter: "(-source$|nixpkgs\.tar\.gz$)"

      - name: Build ${{ matrix.kernel }}
        run: |
          echo "Building ${{ matrix.kernel }}..."
          nix build .#${{ matrix.kernel }}-kernel -L --show-trace

      - name: Build all kernel modules for ${{ matrix.kernel }}
        run: |
          echo "Building kernel modules for ${{ matrix.kernel }}..."
          # Build the full kernel package set which includes modules
          nix build .#${{ matrix.kernel }} -L --show-trace

      - name: Verify build
        run: |
          nix flake check -L

  build-all:
    runs-on: ubuntu-latest
    needs: build-kernels

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.ref_name }} || true

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            max-jobs = auto
            cores = 0

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: ${{ secrets.CACHIX_CACHE_NAME }}
          authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}
          pushFilter: "(-source$|nixpkgs\.tar\.gz$)"

      - name: Build all packages
        run: |
          echo "Building all T2 kernel packages..."
          nix build .#all -L

      - name: Summary
        run: |
          echo "âœ… All T2 kernels built and cached successfully!"
          echo ""
          echo "Available packages:"
          nix flake show

      - name: Post summary
        if: needs.check-updates.outputs.updated == 'true'
        run: |
          {
            echo "## ðŸŽ‰ New Kernel Versions Built"
            echo ""
            echo "New kernel versions have been built and cached!"
            echo ""
            echo "### Packages"
            echo "\`\`\`"
            nix flake show
            echo "\`\`\`"
          } >> $GITHUB_STEP_SUMMARY
