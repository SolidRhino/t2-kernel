name: Check for T2 Updates

on:
  schedule:
    # Check daily at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch: # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      has-updates: ${{ steps.check.outputs.has-updates }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v26
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes

      - name: Check for nixos-hardware updates
        id: check
        run: |
          # Get current nixos-hardware commit
          OLD_COMMIT=$(nix flake metadata --json | jq -r '.locks.nodes["nixos-hardware"].locked.rev')
          echo "Current nixos-hardware: $OLD_COMMIT"

          # Update and get new commit
          nix flake lock --update-input nixos-hardware
          NEW_COMMIT=$(nix flake metadata --json | jq -r '.locks.nodes["nixos-hardware"].locked.rev')
          echo "Latest nixos-hardware: $NEW_COMMIT"

          # Check if changed
          if [ "$OLD_COMMIT" != "$NEW_COMMIT" ]; then
            echo "has-updates=true" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Updates found!"

            # Get kernel versions for the commit message
            STABLE_VER=$(nix eval .#linux-t2-stable.kernel.version --raw 2>/dev/null || echo "unknown")
            LATEST_VER=$(nix eval .#linux-t2-latest.kernel.version --raw 2>/dev/null || echo "unknown")
            echo "STABLE_VERSION=$STABLE_VER" >> $GITHUB_ENV
            echo "LATEST_VERSION=$LATEST_VER" >> $GITHUB_ENV
          else
            echo "has-updates=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date"
            git checkout flake.lock  # Revert the check
          fi

      - name: Create Pull Request
        if: steps.check.outputs.has-updates == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: |
            chore: update nixos-hardware T2 module

            Kernel versions:
            - Stable: ${{ env.STABLE_VERSION }}
            - Latest: ${{ env.LATEST_VERSION }}
          title: "Update T2 kernels and firmware"
          body: |
            ## ðŸ”„ T2 Module Update

            This PR updates the `nixos-hardware` input to get the latest T2 support.

            **May include:**
            - New kernel versions
            - Firmware updates (WiFi, Bluetooth)
            - Audio/TouchBar improvements
            - Bug fixes

            **Current versions:**
            - Stable: `${{ env.STABLE_VERSION }}`
            - Latest: `${{ env.LATEST_VERSION }}`

            ---
            *Auto-generated by daily update check*
          branch: auto-update-t2
          delete-branch: true
          labels: |
            dependencies
            t2-hardware

  # Trigger the build workflow if updates were found
  trigger-build:
    needs: check-updates
    if: needs.check-updates.outputs.has-updates == 'true'
    uses: ./.github/workflows/build-and-cache.yml
    secrets: inherit
